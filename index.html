<!DOCTYPE html>
<html>
  <head>
    <title>Matrix V19 - Corredor e Janelas</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script>
      let emTransicao = false;

      // --- TEXTURAS ---
      AFRAME.registerComponent('textures', {
        init: function () {
          const createTex = (id, color, grid) => {
              const c = document.createElement('canvas'); c.id=id; c.width=256; c.height=256;
              const ctx = c.getContext('2d');
              ctx.fillStyle = color; ctx.fillRect(0,0,256,256);
              if(grid) {
                ctx.fillStyle = "#ffffaa"; // Cor da luz da janela
                for(let x=10; x<256; x+=40) 
                  for(let y=10; y<256; y+=60) 
                    if(Math.random()>0.3) ctx.fillRect(x, y, 20, 30);
              }
              document.body.appendChild(c);
          };
          createTex('tex-janelas', '#222', true);
        }
      });

      // --- LÓGICA DO CORREDOR E APARTAMENTO ---
      function irParaCorredor() {
          const pai = document.querySelector('#interior-root');
          pai.innerHTML = ''; // Limpa tudo
          
          // 1. O CORREDOR (Longo e estreito)
          const corredor = criarCaixa(pai, 0, 101.5, -10, 3, 3, 30, '#ddd');
          corredor.setAttribute('material', 'side: back');

          // 2. PORTAS NO CORREDOR
          for(let z = -22; z < 5; z += 5) {
              const num = 100 + Math.floor((z + 25));
              const porta = criarCaixa(pai, 1.4, 101.1, z, 0.1, 2.2, 1.2, num === 105 ? '#8B4513' : '#444');
              
              const txt = document.createElement('a-text');
              txt.setAttribute('value', num.toString());
              txt.setAttribute('position', '-0.1 1.8 0');
              txt.setAttribute('rotation', '0 -90 0');
              txt.setAttribute('align', 'center'); txt.setAttribute('width', 3);
              porta.appendChild(txt);

              // Sensor para a Porta 105
              if(num === 105) {
                  porta.setAttribute('class', 'interagivel');
                  porta.addEventListener('mouseenter', () => {
                      if(!emTransicao) entrarNo105();
                  });
              }
          }

          // 3. ELEVADOR DE VOLTA (No início do corredor)
          criarCabineElevador(pai, 0, 100, 2, 'RUA');
      }

      function entrarNo105() {
          emTransicao = true;
          const fade = document.querySelector('#fade-screen');
          fade.setAttribute('animation', 'property: material.opacity; from: 0; to: 1; dur: 500');
          
          setTimeout(() => {
              const pai = document.querySelector('#interior-root');
              pai.innerHTML = '';
              // TEU APARTAMENTO
              const apto = criarCaixa(pai, 10, 101.5, -5, 8, 3, 8, '#eee');
              apto.setAttribute('material', 'side: back');
              document.querySelector('#rig').object3D.position.set(10, 100, -5);
              
              const info = document.createElement('a-text');
              info.setAttribute('value', 'APARTAMENTO 105');
              info.setAttribute('position', '10 103 -5'); info.setAttribute('align', 'center');
              pai.appendChild(info);

              fade.setAttribute('animation', 'property: material.opacity; from: 1; to: 0; dur: 500');
              setTimeout(() => { emTransicao = false; }, 2000);
          }, 600);
      }

      // --- REUTILIZÁVEIS ---
      function criarCaixa(pai, x, y, z, w, h, d, cor) {
          const b = document.createElement('a-box');
          b.setAttribute('position', `${x} ${y} ${z}`);
          b.setAttribute('width', w); b.setAttribute('height', h); b.setAttribute('depth', d);
          b.setAttribute('color', cor);
          pai.appendChild(b); return b;
      }

      function criarCabineElevador(pai, x, y, z, destino) {
          const c = document.createElement('a-entity');
          c.setAttribute('position', `${x} ${y} ${z}`);
          criarCaixa(c, 0, 1.25, -1, 2, 2.5, 0.1, '#777'); // Metal
          const sensor = criarCaixa(c, 0, 0.1, 0, 1.5, 0.1, 1.5, '#222');
          sensor.setAttribute('sensor-elevador', `tipo: ${destino}`);
          pai.appendChild(c);
      }

      AFRAME.registerComponent('sensor-elevador', {
        schema: { tipo: {type: 'string'} },
        tick: function () {
            if (emTransicao) return;
            const player = document.querySelector('#rig');
            if (this.el.object3D.getWorldPosition(new THREE.Vector3()).distanceTo(player.object3D.position) < 0.7) {
                emTransicao = true;
                document.querySelector('#fade-screen').setAttribute('animation', 'property: material.opacity; from: 0; to: 1; dur: 800');
                setTimeout(() => {
                    if(this.data.tipo === 'RUA') {
                        player.object3D.position.set(0, 0.2, 5);
                        document.querySelector('#cidade-root').setAttribute('visible', true);
                        document.querySelector('#interior-root').innerHTML = '';
                    } else {
                        player.object3D.position.set(0, 100, 0);
                        document.querySelector('#cidade-root').setAttribute('visible', false);
                        irParaCorredor();
                    }
                    document.querySelector('#fade-screen').setAttribute('animation', 'property: material.opacity; from: 1; to: 0; dur: 800');
                    setTimeout(() => emTransicao = false, 3000);
                }, 1500);
            }
        }
      });
    </script>
  </head>
  <body>
    <a-entity textures></a-entity>
    <a-scene background="color: #000">
      <a-entity id="rig" position="0 0.2 0">
        <a-camera><a-plane id="fade-screen" position="0 0 -0.1" material="color:black;opacity:0;transparent:true"></a-plane><a-cursor></a-cursor></a-camera>
      </a-entity>

      <a-entity id="cidade-root">
        <a-plane rotation="-90 0 0" width="1000" height="1000" color="#111"></a-plane>
        <a-entity position="0 0 -15">
            <a-box position="0 25 0" width="20" height="50" depth="20" material="src: #tex-janelas; repeat: 4 10"></a-box>
            <script>criarCabineElevador(document.querySelector('#cidade-root'), 0, 0, -4, 'APT');</script>
        </a-entity>
      </a-entity>

      <a-entity id="interior-root"></a-entity>
    </a-scene>
  </body>
</html>

