<!DOCTYPE html>
<html>
  <head>
    <title>Matrix V25 - Real Walking System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>

    <script>
      let emTransicao = false;

      // ==========================================
      // SISTEMA DE CAMINHADA REAL (ACELERÓMETRO)
      // ==========================================
      AFRAME.registerComponent('real-walk', {
        init: function () {
          this.prevAcc = 0;
          this.stepThreshold = 1.5; // Sensibilidade do passo
          this.walkingSpeed = 0.15;
          this.isWalking = false;
          
          // Pedir permissão para sensores no iOS/Android moderno
          if (typeof DeviceMotionEvent.requestPermission === 'function') {
            window.addEventListener('click', () => {
              DeviceMotionEvent.requestPermission();
            });
          }
        },
        tick: function () {
          if (emTransicao) return;

          // Captura a rotação da câmara (para onde olhas)
          const cam = document.querySelector('[camera]');
          const rotation = cam.object3D.rotation.y;
          const rig = this.el.object3D;

          // Lógica de detecção de movimento do telemóvel (Passo real)
          window.ondevicemotion = (event) => {
            let acc = event.accelerationIncludingGravity;
            let currentAcc = Math.sqrt(acc.x * acc.x + acc.y * acc.y + acc.z * acc.z);
            let deltaAcc = Math.abs(currentAcc - this.prevAcc);
            
            // Se o telemóvel balançar como um passo humano
            if (deltaAcc > this.stepThreshold) {
              const moveX = Math.sin(rotation) * this.walkingSpeed;
              const moveZ = Math.cos(rotation) * this.walkingSpeed;
              
              rig.position.x -= moveX;
              rig.position.z -= moveZ;
            }
            this.prevAcc = currentAcc;
          };
        }
      });

      // ==========================================
      // GERADOR DE CIDADE ORGANIZADA (V22)
      // ==========================================
      AFRAME.registerComponent('city-logic', {
        init: function () {
          const scene = this.el;
          for (let qX = -4; qX <= 4; qX++) {
            for (let qZ = -4; qZ <= 4; qZ++) {
              if (qX === 0 && qZ === 0) continue;
              const x = qX * 55;
              const z = qZ * 55;
              this.createBlock(scene, x, z);
            }
          }
        },
        createBlock: function(scene, x, z) {
          const block = document.createElement('a-box');
          block.setAttribute('position', `${x} 0.05 ${z}`);
          block.setAttribute('width', 35); block.setAttribute('depth', 35); block.setAttribute('height', 0.1);
          block.setAttribute('color', '#222');
          
          // Prédios simples para performance
          for(let i=0; i<4; i++){
             const p = document.createElement('a-box');
             const px = (i < 2 ? -10 : 10);
             const pz = (i % 2 === 0 ? -10 : 10);
             p.setAttribute('position', `${px} 15 ${pz}`);
             p.setAttribute('width', 15); p.setAttribute('depth', 15); p.setAttribute('height', 30);
             p.setAttribute('color', '#1a1a1a');
             block.appendChild(p);
          }
          scene.appendChild(block);
        }
      });
    </script>
  </head>
  <body>
    <a-scene background="color: #050505" fog="type: exponential; color: #111; density: 0.02">
      
      <a-entity id="rig" position="0 0.2 0" real-walk>
        <a-camera look-controls>
          <a-cursor color="lime"></a-cursor>
          <a-plane id="fade" position="0 0 -0.1" width="2" height="2" color="black" opacity="0" transparent="true"></a-plane>
        </a-camera>
      </a-entity>

      <a-entity id="cidade-root" city-logic>
        <a-plane rotation="-90 0 0" width="2000" height="2000" color="#0a0a0a"></a-plane>
      </a-entity>

    </a-scene>

    <div style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); color: lime; font-family: monospace; text-align: center; background: rgba(0,0,0,0.8); padding: 10px; border: 1px solid lime;">
      DÁ UM PASSO FÍSICO PARA ANDAR<br>
      (Clica no ecrã para ativar sensores)
    </div>

    <script>
      // Ativação por toque para navegadores mobile
      window.addEventListener('click', () => {
        document.querySelector('a-scene').enterVR();
      });
    </script>
  </body>
</html>

