<!DOCTYPE html>
<html>
  <head>
    <title>Matrix V21 - Lojas, Bancos e Shoppings</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script>
      let emTransicao = false;

      // --- 1. GERADOR DE TEXTURAS ---
      AFRAME.registerComponent('urban-assets', {
        init: function () {
          const createTex = (id, color, isWindow) => {
              const c = document.createElement('canvas'); c.id=id; c.width=128; c.height=256;
              const ctx = c.getContext('2d');
              ctx.fillStyle = color; ctx.fillRect(0,0,128,256);
              if(isWindow) {
                ctx.fillStyle = "#ffffaa";
                for(let x=10; x<128; x+=30) 
                  for(let y=10; y<256; y+=40) 
                    if(Math.random()>0.2) ctx.fillRect(x, y, 15, 20);
              }
              document.body.appendChild(c);
          };
          createTex('tex-predio', '#1a1a1a', true);
          createTex('tex-loja', '#333', false);
        }
      });

      // --- 2. GERADOR DE CIDADE COM ZONEAMENTO ---
      AFRAME.registerComponent('city-logic', {
        init: function () {
          const scene = this.el;
          const gridSize = 90;
          const step = 30;

          for (let x = -gridSize; x <= gridSize; x += step) {
            for (let z = -gridSize; z <= gridSize; z += step) {
              if (Math.abs(x) < 5 && Math.abs(z) < 5) continue;
              
              // Sorteio de Tipo de Prédio
              const rand = Math.random();
              let tipo = "LOJA";
              if (rand > 0.8) tipo = "BANCO";
              else if (rand > 0.6) tipo = "SHOPPING";
              else if (rand > 0.4) tipo = "APARTAMENTO";
              
              // O Seu Prédio específico
              if (x === 30 && z === -30) tipo = "SEU_APTO";

              this.createBuilding(scene, x, z, tipo);
            }
          }
        },

        createBuilding: function (pai, x, z, tipo) {
          const grp = document.createElement('a-entity');
          grp.setAttribute('position', `${x} 0 ${z}`);
          
          const h = (tipo === "SHOPPING") ? 15 : 20 + Math.random() * 30;
          const w = (tipo === "SHOPPING") ? 25 : 18;

          // Torre do Prédio
          const b = document.createElement('a-box');
          b.setAttribute('position', `0 ${h/2} 0`);
          b.setAttribute('width', w); b.setAttribute('depth', w); b.setAttribute('height', h);
          b.setAttribute('material', 'src: #tex-predio; repeat: 2 6');
          grp.appendChild(b);

          // Térreo (Fachada)
          const facade = document.createElement('a-box');
          facade.setAttribute('position', `0 2 ${w/2}`);
          facade.setAttribute('width', w - 2); facade.setAttribute('height', 4); facade.setAttribute('depth', 0.5);
          
          // Cores das lojas/shoppings
          let cor = "#444";
          let label = "STORE";
          if (tipo === "BANCO") { cor = "#003366"; label = "BANK"; }
          if (tipo === "SHOPPING") { cor = "#990000"; label = "MALL"; }
          if (tipo === "APARTAMENTO") { cor = "#555"; label = "HOUSE"; }
          if (tipo === "SEU_APTO") { cor = "#006600"; label = "YOUR HOME"; }

          facade.setAttribute('color', cor);
          grp.appendChild(facade);

          // Texto da Placa
          const txt = document.createElement('a-text');
          txt.setAttribute('value', label);
          txt.setAttribute('position', `0 2.5 ${w/2 + 0.3}`);
          txt.setAttribute('align', 'center'); txt.setAttribute('width', 15);
          grp.appendChild(txt);

          // Lógica de Elevador (Apenas Bancos e Apartamentos)
          if (tipo === "BANCO" || tipo === "APARTAMENTO" || tipo === "SEU_APTO") {
            window.criarCabineElevador(grp, 0, 0, w/2 - 2, tipo);
          }

          pai.appendChild(grp);
        }
      });

      // --- 3. LÓGICA DE INTERIORES ESPECÍFICOS ---
      function gerarInteriorEspecial(tipo) {
          const pai = document.querySelector('#interior-root');
          pai.innerHTML = '';
          
          if (tipo === "BANCO") {
              // Interior do Banco com ATMs
              criarCaixa(pai, 0, 100, 0, 10, 0.2, 10, '#708090'); // Piso Mármore
              for(let i=-3; i<=3; i+=2) {
                  const atm = criarCaixa(pai, i, 101, -4, 1, 2, 0.5, '#111');
                  const tela = criarCaixa(atm, 0, 0.3, 0.3, 0.8, 0.4, 0.1, '#00ff00');
              }
          } else if (tipo === "SEU_APTO" || tipo === "APARTAMENTO") {
              // Chama o gerador de corredor/apto que criamos antes
              irParaCorredor(); 
              return;
          }
          
          // Elevador de volta genérico para o Banco
          window.criarCabineElevador(pai, 0, 100, 4, 'RUA');
      }
    </script>
  </head>
  <body>
    <a-entity urban-assets></a-entity>
    <a-scene background="color: #000" fog="type: exponential; color: #111; density: 0.015">
      
      <a-entity id="rig" position="0 0.2 0">
        <a-camera><a-cursor color="lime"></a-cursor></a-camera>
      </a-entity>

      <a-entity id="cidade-root" city-logic>
        <a-plane rotation="-90 0 0" width="1000" height="1000" color="#111"></a-plane>
      </a-entity>

      <a-entity id="interior-root"></a-entity>

    </a-scene>
  </body>
</html>

