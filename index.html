<!DOCTYPE html>
<html>
  <head>
    <title>Matrix V22 - Quarteirões Realistas</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script>
      // --- GERADOR DE TEXTURAS ---
      AFRAME.registerComponent('urban-assets', {
        init: function () {
          const createTex = (id, color, isWindow) => {
              const c = document.createElement('canvas'); c.id=id; c.width=128; c.height=256;
              const ctx = c.getContext('2d');
              ctx.fillStyle = color; ctx.fillRect(0,0,128,256);
              if(isWindow) {
                ctx.fillStyle = "#ffffaa";
                for(let x=10; x<128; x+=30) 
                  for(let y=10; y<256; y+=40) 
                    if(Math.random()>0.2) ctx.fillRect(x, y, 15, 20);
              }
              document.body.appendChild(c);
          };
          createTex('tex-predio', '#1a1a1a', true);
          createTex('tex-calcada', '#444', false);
        }
      });

      // --- LÓGICA DE CIDADE ORGANIZADA ---
      AFRAME.registerComponent('city-grid', {
        init: function () {
          const scene = this.el;
          const numQuarteiroes = 6; 
          const tamanhoQuarteirao = 40; // Espaço do bloco
          const larguraRua = 15;      // Espaço vazio entre prédios

          for (let qX = -numQuarteiroes; qX <= numQuarteiroes; qX++) {
            for (let qZ = -numQuarteiroes; qZ <= numQuarteiroes; qZ++) {
              
              // Calcula a posição do quarteirão
              let posX = qX * (tamanhoQuarteirao + larguraRua);
              let posZ = qZ * (tamanhoQuarteirao + larguraRua);

              // Pula o centro absoluto
              if (Math.abs(qX) < 1 && Math.abs(qZ) < 1) continue;

              // Determina o tipo pelo local (Centro = Comercial, Longe = Residencial)
              let distanciaCentro = Math.sqrt(qX*qX + qZ*qZ);
              let tipo = (distanciaCentro < 2.5) ? "COMERCIAL" : "RESIDENCIAL";
              
              if (qX === 1 && qZ === 1) tipo = "SEU_APTO";

              this.gerarQuarteirao(scene, posX, posZ, tipo, tamanhoQuarteirao);
            }
          }
        },

        gerarQuarteirao: function (pai, baseX, baseZ, tipoGeral, tam) {
          // Cada quarteirão terá 4 prédios (2x2)
          const offsets = [-10, 10];
          
          offsets.forEach(offX => {
            offsets.forEach(offZ => {
              const x = baseX + offX;
              const z = baseZ + offZ;
              
              // Sorteia tipo específico dentro do zoneamento
              let tipoSub = "LOJA";
              if (tipoGeral === "COMERCIAL") {
                tipoSub = Math.random() > 0.5 ? "BANCO" : "SHOPPING";
              } else {
                tipoSub = "APARTAMENTO";
              }
              if (tipoGeral === "SEU_APTO") tipoSub = "SEU_APTO";

              this.criarPredio(pai, x, z, tipoSub);
            });
          });

          // Cria a calçada embaixo do quarteirão
          const calcada = document.createElement('a-box');
          calcada.setAttribute('position', `${baseX} 0.05 ${baseZ}`);
          calcada.setAttribute('width', tam); calcada.setAttribute('depth', tam); calcada.setAttribute('height', 0.1);
          calcada.setAttribute('color', '#333');
          pai.appendChild(calcada);
        },

        criarPredio: function (pai, x, z, tipo) {
          const h = (tipo === "SHOPPING") ? 15 : 25 + Math.random() * 25;
          const w = 15;

          const b = document.createElement('a-box');
          b.setAttribute('position', `${x} ${h/2} ${z}`);
          b.setAttribute('width', w); b.setAttribute('depth', w); b.setAttribute('height', h);
          b.setAttribute('material', 'src: #tex-predio; repeat: 2 6');
          
          // Placa indicativa
          const cores = { "BANCO": "blue", "SHOPPING": "red", "APARTAMENTO": "gray", "SEU_APTO": "green" };
          const moldura = document.createElement('a-box');
          moldura.setAttribute('position', `0 ${-h/2 + 2} ${w/2 + 0.1}`);
          moldura.setAttribute('width', 8); moldura.setAttribute('height', 2); moldura.setAttribute('depth', 0.2);
          moldura.setAttribute('color', cores[tipo] || "black");
          
          const txt = document.createElement('a-text');
          txt.setAttribute('value', tipo); txt.setAttribute('align', 'center'); txt.setAttribute('width', 10);
          txt.setAttribute('position', '0 0 0.2');
          moldura.appendChild(txt);
          b.appendChild(moldura);

          pai.appendChild(b);
        }
      });
    </script>
  </head>
  <body>
    <a-entity urban-assets></a-entity>
    <a-scene background="color: #111" fog="type: exponential; color: #2c3e50; density: 0.01">
      
      <a-entity id="rig" position="0 0.2 0" gamepad-move>
        <a-camera><a-cursor color="lime"></a-cursor></a-camera>
      </a-entity>

      <a-entity id="cidade-root" city-grid>
        <a-plane rotation="-90 0 0" width="1000" height="1000" color="#111"></a-plane>
      </a-entity>

    </a-scene>
  </body>
</html>

