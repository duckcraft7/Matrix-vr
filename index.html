<!DOCTYPE html>
<html>
  <head>
    <title>Matrix Realista - Bluetooth & Interiores</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>

    <script>
      // ==========================================
      // 1. GERADOR DE TEXTURAS (Janelas Grandes)
      // ==========================================
      AFRAME.registerComponent('texture-manager', {
        init: function () {
          // --- TEXTURA PRÉDIO (Janelões) ---
          const canvas = document.createElement('canvas'); 
          canvas.id = 'tex-predio'; canvas.width = 256; canvas.height = 256;
          const ctx = canvas.getContext('2d');
          
          // Fundo Concreto Escuro
          ctx.fillStyle = '#404040'; ctx.fillRect(0,0,256,256);
          
          // Janelas Grandes e Espaçadas
          const larguraJ = 40;
          const alturaJ = 50;
          const espaco = 20;
          
          for(let y=10; y<250; y += (alturaJ + espaco)) {
            for(let x=10; x<250; x += (larguraJ + espaco)) {
                // Vidro Azulado com variação de luz
                const luz = Math.random();
                if(luz > 0.3) {
                    ctx.fillStyle = `rgb(100, 150, ${200 + Math.random()*55})`; // Azul Variável
                } else {
                    ctx.fillStyle = '#1a1a1a'; // Luz apagada
                }
                ctx.fillRect(x, y, larguraJ, alturaJ);
                
                // Reflexo no vidro
                ctx.fillStyle = 'rgba(255,255,255,0.1)';
                ctx.fillRect(x, y, larguraJ, alturaJ/2);
            }
          }
          canvas.style.display = 'none'; document.body.appendChild(canvas);

          // --- TEXTURA INTERIOR (Piso e Parede) ---
          const c2 = document.createElement('canvas'); c2.id='tex-chao'; c2.width=64; c2.height=64;
          const ctx2 = c2.getContext('2d');
          ctx2.fillStyle='#e0e0e0'; ctx2.fillRect(0,0,64,64); // Mármore branco
          ctx2.strokeStyle='#ccc'; ctx2.strokeRect(0,0,64,64);
          c2.style.display='none'; document.body.appendChild(c2);
        }
      });

      // ==========================================
      // 2. CONTROLE BLUETOOTH (Gamepad)
      // ==========================================
      AFRAME.registerComponent('gamepad-move', {
        init: function () {
          this.speed = 0.15; // Velocidade de caminhada
        },
        tick: function () {
          const gamepads = navigator.getGamepads ? navigator.getGamepads() : [];
          if (!gamepads) return;

          // Procura o primeiro controle ativo
          const gp = gamepads[0] || gamepads[1]; 
          if (gp) {
            // Eixos Padrão: 0 = Esq/Dir, 1 = Frente/Trás
            const x = gp.axes[0]; 
            const z = gp.axes[1];

            // Zona morta (para o boneco não andar sozinho)
            if (Math.abs(x) < 0.1 && Math.abs(z) < 0.1) return;

            const el = this.el;
            const angle = el.object3D.rotation.y; // Rotação atual do corpo/câmera
            
            // Matemática para mover na direção que você está olhando
            const dx = (x * Math.cos(angle) + z * Math.sin(angle)) * this.speed;
            const dz = (z * Math.cos(angle) - x * Math.sin(angle)) * this.speed;

            el.object3D.position.x += dx;
            el.object3D.position.z += dz;
          }
        }
      });

      // ==========================================
      // 3. CONSTRUTOR DE PRÉDIOS "ENTRÁVEIS"
      // ==========================================
      AFRAME.registerComponent('cidade-realista', {
        init: function () {
            const scene = this.el;
            const range = 4; // Tamanho da cidade
            const tamanho = 25; // Espaço entre ruas
            
            for (let x = -range; x <= range; x++) {
                for (let z = -range; z <= range; z++) {
                    if (x === 0 && z === 0) continue; // Centro livre

                    if (Math.random() > 0.2) {
                        this.construirPredio(scene, x * tamanho, z * tamanho);
                    } else {
                        this.criarNPC(scene, x * tamanho, z * tamanho);
                    }
                }
            }
        },

        construirPredio: function (pai, x, z) {
            const grupo = document.createElement('a-entity');
            grupo.setAttribute('position', `${x} 0 ${z}`);

            const largura = 14;
            const profundidade = 14;
            const alturaTotal = 15 + Math.random() * 25;
            const alturaTerreo = 4; // Altura do Lobby

            // 1. TÉRREO (Lobby Aberto para entrar)
            // Piso interno
            const chao = document.createElement('a-box');
            chao.setAttribute('position', `0 0.1 0`);
            chao.setAttribute('width', largura-1); chao.setAttribute('depth', profundidade-1); 
            chao.setAttribute('height', 0.2);
            chao.setAttribute('material', 'src: #tex-chao; repeat: 4 4');
            grupo.appendChild(chao);

            // Colunas (em vez de paredes fechadas na frente)
            this.criarColuna(grupo, -6, 2, -6);
            this.criarColuna(grupo, 6, 2, -6);
            this.criarColuna(grupo, -6, 2, 6);
            this.criarColuna(grupo, 6, 2, 6);

            // Parede de Fundo (Lobby)
            this.criarParede(grupo, 0, 2, -6.5, largura, 4, 0.5);
            // Tetos do lobby
            this.criarParede(grupo, 0, 4, 0, largura, 0.5, profundidade);

            // 2. TORRE (A parte de cima)
            const torre = document.createElement('a-box');
            torre.setAttribute('position', `0 ${4 + (alturaTotal/2)} 0`);
            torre.setAttribute('width', largura);
            torre.setAttribute('depth', profundidade);
            torre.setAttribute('height', alturaTotal);
            torre.setAttribute('material', 'src: #tex-predio; repeat: 2 6');
            torre.setAttribute('shadow', 'cast: true; receive: true');
            grupo.appendChild(torre);

            pai.appendChild(grupo);
        },

        criarColuna: function(pai, x, y, z) {
            const col = document.createElement('a-box');
            col.setAttribute('position', `${x} ${y} ${z}`);
            col.setAttribute('width', 1); col.setAttribute('depth', 1); col.setAttribute('height', 4);
            col.setAttribute('color', '#333');
            pai.appendChild(col);
        },

        criarParede: function(pai, x, y, z, w, h, d) {
            const wall = document.createElement('a-box');
            wall.setAttribute('position', `${x} ${y} ${z}`);
            wall.setAttribute('width', w); wall.setAttribute('height', h); wall.setAttribute('depth', d);
            wall.setAttribute('color', '#555');
            pai.appendChild(wall);
        },

        // --- NPCS REALISTAS (Estilo Minecraft) ---
        criarNPC: function (pai, x, z) {
            const npc = document.createElement('a-entity');
            npc.setAttribute('position', `${x} 0 ${z}`);
            npc.setAttribute('npc-walker', '');

            // Grupo visual (para rotacionar o corpo todo)
            const visual = document.createElement('a-entity');
            visual.setAttribute('id', 'visual');
            
            // Cores de Roupa
            const corCamisa = ['#1a1a1a', '#003366', '#330000', '#eee'][Math.floor(Math.random()*4)];
            const corCalca = ['#000', '#222', '#111'][Math.floor(Math.random()*3)];

            // Perna Esq
            this.criarMembro(visual, -0.2, 0.4, 0, 0.15, 0.8, 0.2, corCalca);
            // Perna Dir
            this.criarMembro(visual, 0.2, 0.4, 0, 0.15, 0.8, 0.2, corCalca);
            // Tronco
            this.criarMembro(visual, 0, 1.1, 0, 0.6, 0.7, 0.3, corCamisa);
            // Braços
            this.criarMembro(visual, -0.4, 1.1, 0, 0.15, 0.7, 0.2, corCamisa);
            this.criarMembro(visual, 0.4, 1.1, 0, 0.15, 0.7, 0.2, corCamisa);
            // Cabeça
            const cabeca = document.createElement('a-box');
            cabeca.setAttribute('position', '0 1.65 0');
            cabeca.setAttribute('width', 0.25); cabeca.setAttribute('height', 0.25); cabeca.setAttribute('depth', 0.25);
            cabeca.setAttribute('color', '#ffdbac'); // Pele
            visual.appendChild(cabeca);

            npc.appendChild(visual);
            pai.appendChild(npc);
        },

        criarMembro: function(pai, x, y, z, w, h, d, cor) {
            const box = document.createElement('a-box');
            box.setAttribute('position', `${x} ${y} ${z}`);
            box.setAttribute('width', w); box.setAttribute('height', h); box.setAttribute('depth', d);
            box.setAttribute('color', cor);
            pai.appendChild(box);
        }
      });

      // ==========================================
      // 4. IA DOS NPCS (Andar e Girar)
      // ==========================================
      AFRAME.registerComponent('npc-walker', {
        init: function() {
            this.dir = Math.random() * Math.PI * 2;
            this.speed = 0.02 + Math.random() * 0.03;
            this.turnTimer = 0;
        },
        tick: function() {
            const el = this.el;
            const pos = el.object3D.position;
            
            // Move
            pos.x += Math.sin(this.dir) * this.speed;
            pos.z += Math.cos(this.dir) * this.speed;

            // Visual Rotation (Olhar para onde anda)
            const visual = el.querySelector('#visual');
            if(visual) visual.object3D.rotation.y = this.dir;

            // Timer para mudar de direção
            this.turnTimer++;
            if(this.turnTimer > 300) { // A cada 300 frames muda
                this.dir = Math.random() * Math.PI * 2;
                this.turnTimer = 0;
            }

            // Limite do mundo (volta se for longe)
            if(Math.abs(pos.x) > 80 || Math.abs(pos.z) > 80) {
                this.dir += Math.PI; // Meia volta
            }
        }
      });

    </script>
  </head>
  
  <body>
    <a-entity texture-manager></a-entity>

    <a-scene background="color: #87CEEB" 
             fog="type: exponential; color: #aaa; density: 0.01"
             shadow="type: basic">
      
      <a-entity light="type: directional; color: #fff; intensity: 1; castShadow: true" 
                position="-20 50 30"></a-entity>
      <a-entity light="type: ambient; color: #666"></a-entity>

      <a-plane position="0 0 0" rotation="-90 0 0" width="300" height="300" 
               color="#222"></a-plane>

      <a-entity cidade-realista></a-entity>

      <a-entity id="rig" position="0 0 0" gamepad-move>
        <a-camera position="0 1.7 0" look-controls="pointerLockEnabled: true">
            <a-cursor color="white" scale="0.5 0.5 0.5" opacity="0.5"></a-cursor>
            <a-text value="Use o Joystick para andar" position="0 -0.5 -1" align="center" width="1.5" color="yellow"></a-text>
        </a-camera>
      </a-entity>

    </a-scene>
  </body>
</html>

